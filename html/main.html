<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- TODO: amcharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.6/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/rowgroup/1.1.2/js/dataTables.rowGroup.min.js"></script>
    <script src="https://kit.fontawesome.com/2383fc25b0.js" crossorigin="anonymous"></script>
    <script src="util.js"></script>
    <script type="text/javascript">
    const allData = f71dbe52628a3f83a77ab494817525c6;
    let filteredData = allData;
    const wings = [...new Set(allData.map(item => item.wing))].sort();
    const years = [...new Set(allData.map(item => item.year))].sort();
    const sites = [...new Set(allData.map(item => item.site))].sort();

    let appliedFilters = [0, 0, 0]; // wing/year/site
    let filterStrings = ['', '', ''];
    </script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <link href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.2.6/css/responsive.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/rowgroup/1.1.2/css/rowGroup.dataTables.min.css" rel="stylesheet">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=9c2646307b6841b858e16446a494f05a"></script>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <!-- Resources -->
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', '9c2646307b6841b858e16446a494f05a');
    
    </script>
    <title>{{{pilot.name}}}'s pilot page</title>
</head>

<body>
    [[[skeleton]]]
    [[[modal]]]
    <script type="text/javascript">
    </script>
    <script type="text/javascript">
    $(document).ready(function() {
        redrawWingsFilter(wings);
        redrawYearsFilter(years);
        redrawSitesFilter(sites);
        redrawViz(filteredData);

        $("#site_input").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#sitesFilter li.filterable").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
        $('.close_modal').click(function() {
            $('#mapinsert').remove();
            $('<div id="mapinsert" class="modal-body"></div>').insertAfter("#before_modal");
        })
        $('.table_viewer').click(function() {
            var currentRow = $(this).closest("tr");
            var data = $('#flights_table').DataTable().row(currentRow).data();
            var id = parseInt(data['id']);
            var igc = data['hasIGC'];
            setViewer(id, igc)

        });

        $('.viewer').click(function() {
            var id = $(this).data('id');
            setViewer(id, true);

        });
        $('.year_item').click(function() {
            year_label = $(this).text();
            if ($(this).attr("id") == 'season_0') {
                appliedFilters[1] = 0; // wing/year/site
                filterStrings[1] = '';
            } else {
                appliedFilters[1] = 1; // wing/year/site
                filterStrings[1] = year_label;
            }
            $('#nb_years').text(year_label);
            filteredData = applyFilters(allData, appliedFilters, filterStrings);
            redrawViz(filteredData);
        });

        $('.wing_item').click(function() {
            wing_label = $(this).text();
            if ($(this).attr("id") == 'wing_0') {
                appliedFilters[0] = 0; // wing/year/site
                filterStrings[0] = '';
            } else {
                appliedFilters[0] = 1; // wing/year/site
                filterStrings[0] = wing_label;
            }
            $('#nb_wings').text(wing_label);
            filteredData = applyFilters(allData, appliedFilters, filterStrings);
            redrawViz(filteredData);
            $('.wing_item.active').not($(this)).removeClass('active');
            $(this).toggleClass('active');
        });

        $('.site_item').click(function() {
            site_label = $(this).text();
            if ($(this).attr("id") == 'site_0') {
                appliedFilters[2] = 0; // wing/year/site
                filterStrings[2] = '';
            } else {
                appliedFilters[2] = 1; // wing/year/site
                filterStrings[2] = site_label;
            }
            $('#nb_sites').text(site_label);
            filteredData = applyFilters(allData, appliedFilters, filterStrings);
            redrawViz(filteredData);
            var value = '';
            $("#sitesFilter li.filterable").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
            $('#site_input').val('');
        });

        var myDropdown = document.getElementById('site_down')
        myDropdown.addEventListener('shown.bs.dropdown', function() {
            document.getElementById('site_input').focus();

        })
        myDropdown.addEventListener('hidden.bs.dropdown', function() {
            var value = '';
            $("#sitesFilter li.filterable").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
            $('#site_input').val('');

        })

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous" async></script>
</body>

</html>